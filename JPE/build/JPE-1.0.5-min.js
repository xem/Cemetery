/*
 * Copyright (c) 2011 http://colorhook.com
 * @author: <a href="colorhook@gmail.com">colorhook</a>
 * @version: 1.0.1
 * @license: Released under the MIT License.
 *
 * Transplant from Flash AS3 APE Engine
 * http://www.cove.org/ape/
 * Copyright (c) 2006, 2007 Alec Cove
 * Released under the MIT License.
 */
(function(j){var b={VERSION:"1.0.5"},f="JPE",d=0,c=["hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toString","toLocaleString","valueOf"],g=!{valueOf:0}.propertyIsEnumerable("valueOf"),e=Object.prototype.hasOwnProperty,k=Object.prototype.toString,a=function(l){return k.call(l)==="[object Function]"},i=function(n,m){var l=typeof n;return(n&&(l==="object"||(!m&&(l==="function"||a(n)))))||false},h=function(l,m,t,n,p,u){var q,x,w,o,y,r,v;if(!l||!m){return l}if(p){if(p===2){h(l.prototype,m.prototype,t,n,0,u)}w=p===1||p===3?m.prototype:m;v=p===1||p===4?l.prototype:l;if(!w||!v){return l}}else{w=m;v=l}q=t&&!u;if(n){for(o=0,r=n.length;o<r;++o){y=n[o];if(!e.call(w,y)){continue}x=q?false:y in v;if(u&&x&&i(v[y],true)&&i(w[y],true)){h(v[y],w[y],t,null,0,u)}else{if(t||!x){v[y]=w[y]}}}}else{for(y in w){if(!e.call(w,y)){continue}x=q?false:y in v;if(u&&x&&i(v[y],true)&&i(w[y],true)){h(v[y],w[y],t,null,0,u)}else{if(t||!x){v[y]=w[y]}}}if(g){h(v,w,t,c,p,u)}}return l};h(b,{mix:h,guid:function(l){var m=(d++)+"";return l?l+m:m},isFunction:a,isObject:i,isUndefined:function(l){return l===undefined},isBoolean:function(l){return k.call(l)==="[object Boolean]"},isString:function(l){return k.call(l)==="[object String]"},isNumber:function(l){return k.call(l)==="[object Number]"&&isFinite(l)},isArray:function(l){return k.call(l)==="[object Array]"},Array:{indexOf:function(m,p){if(m.indexOf){return m.indexOf(p)}for(var o=0,n=m.length;o<n;o++){if(m[o]===p){return o}}return -1},each:function(m,p){for(var o=0,n=m.length;o<n;o++){p(m[o],o,m)}},remove:function(l,n){var m=this.indexOf(l,n);if(m!=-1){return l.splice(m,1)}}},merge:function(){var n=arguments,q={},p,m=n.length;for(p=0;p<m;p=p+1){h(q,n[p],true)}return q},namespace:function(q){var n=arguments,u=null,r,p,t,m;for(r=0;r<n.length;r=r+1){t=(""+n[r]).split(".");u=this;m=t.length;for(p=(t[0]==f)?1:0;p<m;p=p+1){u[t[p]]=u[t[p]]||{};u=u[t[p]]}}return u},extend:function(p,o,m,u){if(!o||!p){return p}var l=Object.prototype,t=function(v){function r(){}r.prototype=v;return new r()},q=o.prototype,n=t(q);p.prototype=n;n.constructor=p;p.superclass=q;if(o!=Object&&q.constructor==l.constructor){q.constructor=o}if(m){h(n,m,true)}if(u){h(p,u,true)}p.superclass=o;return p},declare:function(v,m,w){var z=this;if(this.isFunction(m)){var n=m();if(!z.isUndefined(n)){z.declare(v,n,w)}else{h(this.namespace(v),w)}return}m=m||{};var y=m.superclass,x,u,r,t,q;if(m.hasOwnProperty("constructor")&&this.isFunction(m.constructor)){x=m.constructor}else{if(!y){x=function(){}}else{x=function(){y.prototype.constructor.apply(this,arguments)}}}delete m.constructor;if(!y){this.mix(x.prototype,m);this.mix(x,w)}else{x=this.extend(x,y,m,w)}u=(""+v).split(".");t=(u[0]==f)?1:0;r=u.length;q=this;for(;t<r;t++){if(t==r-1){q[u[t]]=x}else{q[u[t]]=q[u[t]]||{}}q=q[u[t]]}return q}});j[f]=b})(window);JPE.declare("Signal",{__bindings:null,__bindingsOnce:null,constructor:function(){this.__bindings=[];this.__bindingsOnce=[]},add:function(a){return this.registerListener(a)},addOnce:function(a){return this.registerListener(a,true)},remove:function(b){var a=this.find(b),c=this.find(b,this.__bindingsOnce);if(a>=0){this.__bindings.splice(a,1)}if(c>=0){this.__bindingsOnce.splice(c,1)}},removeAll:function(){this.__bindings.length=0;this.__bindingsOnce.length=0},dispatch:function(){var b=Array.prototype.slice.call(arguments),f=this.__bindings,d=f.concat(),e;for(var c=0,a=d.length;c<a;c++){e=d[c];e.apply(null,b);if(this.find(e,this.__bindingsOnce)!=-1){this.remove(e)}}},getNumListeners:function(){return this.__bindings.length},registerListener:function(c,b){var a=this.find(c);if(a==-1||!b){this.__bindings.push(c);if(b){this.__bindingsOnce.push(c)}}},find:function(d,a){a=a||this.__bindings;if(a.indexOf){return a.indexOf(d)}for(var c=0,b=a.length;c<b;c++){if(a[c]===d){return c}}return -1}});JPE.Engine={force:null,masslessForce:null,groups:null,numGroups:0,timeStep:0,renderer:null,damping:1,constraintCycles:0,constraintCollisionCycles:1,init:function(a){if(isNaN(a)){a=0.25}this.timeStep=a*a;this.groups=[];this.force=new JPE.Vector(0,0);this.masslessForce=new JPE.Vector(0,0)},addForce:function(a){this.force.plusEquals(a)},addMasslessForce:function(a){this.masslessForce.plusEquals(a)},addGroup:function(a){this.groups.push(a);a.isParented=true;this.numGroups++;a.initSelf()},removeGroup:function(a){var b=JPE.Array.indexOf(this.groups,a);if(b==-1){return}this.groups.splice(b,1);a.isParented=false;this.numGroups--;a.cleanup()},step:function(){this.integrate();for(var a=0;a<this.constraintCycles;a++){this.satisfyConstraints()}for(var b=0;b<this.constraintCollisionCycles;b++){this.satisfyConstraints();this.checkCollisions()}},paint:function(){for(var a=0;a<this.numGroups;a++){var b=this.groups[a];b.paint()}},integrate:function(){for(var a=0;a<this.numGroups;a++){var b=this.groups[a];b.integrate(this.timeStep)}},satisfyConstraints:function(){for(var a=0;a<this.numGroups;a++){var b=this.groups[a];b.satisfyConstraints()}},checkCollisions:function(){for(var a=0;a<this.numGroups;a++){var b=this.groups[a];b.checkCollisions()}}};(function(){var a=function(c,b){this.x=c||0;this.y=b||0};JPE.mix(a.prototype,{setTo:function(c,b){this.x=c||0;this.y=b||0},copy:function(b){this.x=b.x;this.y=b.y},dot:function(b){return this.x*b.x+this.y*b.y},cross:function(b){return this.x*b.y+this.y*b.x},plus:function(b){return new a(this.x+b.x,this.y+b.y)},plusEquals:function(b){this.x+=b.x;this.y+=b.y;return this},minus:function(b){return new a(this.x-b.x,this.y-b.y)},minusEquals:function(b){this.x-=b.x;this.y-=b.y;return this},mult:function(b){return new a(this.x*b,this.y*b)},multEquals:function(b){this.x*=b;this.y*=b;return this},times:function(b){return new a(this.x*b.x,this.y*b.y)},divEquals:function(b){if(b==0){b=0.0001}this.x/=b;this.y/=b;return this},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},distance:function(b){var c=this.minus(b);return c.magnitude()},normalize:function(){var b=this.magnitude();if(b==0){b=0.0001}return this.mult(1/b)},toString:function(){return(this.x+" : "+this.y)}});JPE.Vector=a})();JPE.declare("Interval",{constructor:function(b,a){this.min=b;this.max=a}});JPE.declare("Collision",{constructor:function(a,b){this.vn=a;this.vt=b}});JPE.declare("SmashSignal",{superclass:JPE.Signal},{COLLISION:"collision"});JPE.MathUtil={ONE_EIGHTY_OVER_PI:180/Math.PI,PI_OVER_ONE_EIGHTY:Math.PI/180,clamp:function(c,b,a){if(c<b){return b}if(c>a){return a}return c},sign:function(a){if(a<0){return -1}return 1}};JPE.declare("AbstractItem",{constructor:function(){this._visible=true;this._alwaysRepaint=true;this.lineTickness=0;this.lineColor=0;this.lineAlpha=1;this.fillColor=3355443;this.fillAlpha=1;this._pool={};this.beforeRenderSignal=new JPE.Signal();this.afterRenderSignal=new JPE.Signal()},get:function(a){return this._pool[a]},set:function(a,b){this._pool[a]=b},initSelf:function(){var a=this.initSelfFunction||this.constructor.initSelfFunction;if(JPE.isFunction(a)){a(this)}else{JPE.Engine.renderer.initSelf(this)}this.paint()},cleanup:function(){var a=this.cleanupFunction||this.constructor.cleanupFunction;if(JPE.isFunction(a)){a(this)}else{JPE.Engine.renderer.cleanup(this)}},paint:function(){this.render()},render:function(){this.beforeRenderSignal.dispatch(this);var a=this.renderFunction||this.constructor.renderFunction;if(JPE.isFunction(a)){a(this)}else{JPE.Engine.renderer.render(this)}this.afterRenderSignal.dispatch(this)},getVisible:function(){return this._visible},setVisible:function(a){if(a==this._visible){return}this._visible=a;JPE.Engine.renderer.setVisible(this)},getAlwaysRepaint:function(){return this._alwaysRepaint},setAlwaysRepaint:function(a){this._alwaysRepaint=a},setStyle:function(c,d,a,e,b){c=c||0;d=d||0;a=a||1;e=e||0;b=b||1;this.setLine(c,d,a);this.setFill(e,b)},setLine:function(b,a,c){this.lineThickness=b;this.lineColor=a;this.lineAlpha=c},setFill:function(a,b){this.fillColor=a;this.fillAlpha=b}});JPE.CollisionResolver={resolveParticleParticle:function(m,l,k,g){m.curr.copy(m.samp);l.curr.copy(l.samp);var n=k.mult(g);var d=m.getElasticity()+l.getElasticity();var h=m.getInvMass()+l.getInvMass();var c=this.clamp(1-(m.getFriction()+l.getFriction()),0,1);var f=m.getComponents(k);var e=l.getComponents(k);var j=(e.vn.mult((d+1)*m.getInvMass()).plus(f.vn.mult(l.getInvMass()-d*m.getInvMass()))).divEquals(h);var i=(f.vn.mult((d+1)*l.getInvMass()).plus(e.vn.mult(m.getInvMass()-d*l.getInvMass()))).divEquals(h);f.vt.multEquals(c);e.vt.multEquals(c);var b=n.mult(m.getInvMass()/h);var a=n.mult(-l.getInvMass()/h);j.plusEquals(f.vt);i.plusEquals(e.vt);if(!m.getFixed()){m.resolveCollision(b,j,k,g,-1,l)}if(!l.getFixed()){l.resolveCollision(a,i,k,g,1,m)}},clamp:function(b,c,a){if(b>a){return a}if(b<c){return c}return b}};JPE.declare("CollisionDetector",function(){var b=Number.POSITIVE_INFINITY;var a=JPE.Vector;JPE.CollisionDetector={test:function(d,c){if(d.getFixed()&&c.getFixed()){return}if(d.getMultisample()==0&&c.getMultisample()==0){this.normVsNorm(d,c)}else{if(d.getMultisample()>0&&c.getMultisample()==0){this.sampVsNorm(d,c)}else{if(c.getMultisample()>0&&d.getMultisample()==0){this.sampVsNorm(c,d)}else{if(d.getMultisample()==c.getMultisample()){this.sampVsSamp(d,c)}else{this.normVsNorm(d,c)}}}}},normVsNorm:function(d,c){d.samp.copy(d.curr);c.samp.copy(c.curr);this.testTypes(d,c)},sampVsNorm:function(g,c){var f=g.getMultisample(),h=1/(f+1),e=h,d;c.samp.copy(c.curr);for(d=0;d<=f;d++){g.samp.setTo(g.prev.x+e*(g.curr.x-g.prev.x),g.prev.y+e*(g.curr.y-g.prev.y));if(this.testTypes(g,c)){return}e+=h}},sampVsSamp:function(g,c){var f=g.getMultisample(),h=1/(f+1),e=h,d;for(d=0;d<=f;d++){g.samp.setTo(g.prev.x+e*(g.curr.x-g.prev.x),g.prev.y+e*(g.curr.y-g.prev.y));c.samp.setTo(c.prev.x+e*(c.curr.x-c.prev.x),c.prev.y+e*(c.curr.y-c.prev.y));if(this.testTypes(g,c)){return}e+=h}},testTypes:function(e,d){var c=e.constructor,i=d.constructor,g=JPE.RectangleParticle,h=JPE.CircleParticle;if((e instanceof g)&&(d instanceof g)){var f=this.testOBBvsOBB(e,d);return f}else{if((e instanceof h)&&(d instanceof h)){return this.testCirclevsCircle(e,d)}else{if((e instanceof g)&&(d instanceof h)){return this.testOBBvsCircle(e,d)}else{if((e instanceof h)&&(d instanceof g)){return this.testOBBvsCircle(d,e)}}}}return false},testOBBvsOBB:function(e,c){var k,q=b;for(var l=0;l<2;l++){var j=e.getAxes()[l],m=e.getProjection(j),f=c.getProjection(j),p=this.testIntervals(m,f);if(p==0){return false}var h=c.getAxes()[l],o=this.testIntervals(e.getProjection(h),c.getProjection(h));if(o==0){return false}var g=Math.abs(p),d=Math.abs(o);if(g<Math.abs(q)||d<Math.abs(q)){var n=g<d;k=n?j:h;q=n?p:o}}JPE.CollisionResolver.resolveParticleParticle(e,c,k,q);return true},testOBBvsCircle:function(d,e){var f,n=b,m=new Array(2),h=0,l,g,c;for(;h<2;h++){l=d.getAxes()[h];g=this.testIntervals(d.getProjection(l),e.getProjection(l));if(g==0){return false}if(Math.abs(g)<Math.abs(n)){f=l;n=g}m[h]=g}c=e.getRadius();if(Math.abs(m[0])<c&&Math.abs(m[1])<c){var k=this.closestVertexOnOBB(e.samp,d);f=k.minus(e.samp);var j=f.magnitude();n=c-j;if(n>0){f.divEquals(j)}else{return false}}JPE.CollisionResolver.resolveParticleParticle(d,e,f,n);return true},testCirclevsCircle:function(e,c){var g=this.testIntervals(e.getIntervalX(),c.getIntervalX());if(g==0){return false}var f=this.testIntervals(e.getIntervalY(),c.getIntervalY());if(f==0){return false}var d=e.samp.minus(c.samp),h=d.magnitude(),i=e.getRadius()+c.getRadius()-h;if(i>0){d.divEquals(h);JPE.CollisionResolver.resolveParticleParticle(e,c,d,i);return true}return false},testIntervals:function(f,e){if(f.max<e.min){return 0}if(e.max<f.min){return 0}var d=e.max-f.min,c=e.min-f.max;return(Math.abs(d)<Math.abs(c))?d:c},closestVertexOnOBB:function(g,e){var j=g.minus(e.samp),f=new a(e.samp.x,e.samp.y),c=0;for(;c<2;c++){var h=j.dot(e.getAxes()[c]);if(h>=0){h=e.getExtents()[c]}else{if(h<0){h=-e.getExtents()[c]}}f.plusEquals(e.getAxes()[c].mult(h))}return f}}});JPE.declare("AbstractCollection",{isParented:false,container:null,constructor:function(){this.particles=[];this.constraints=[]},initSelf:function(){var e=this.particles,d=this.constraints,c=e.length,a=d.length,b;for(b=0;b<c;b++){e[b].initSelf()}for(b=0;b<a;b++){d[b].initSelf()}},addParticle:function(a){this.particles.push(a);if(this.isParented){a.initSelf()}},removeParticle:function(b){var a=JPE.Array.indexOf(this.particles,b);if(a==-1){return}this.particles.splice(a,1);b.cleanup()},addConstraint:function(a){this.constraints.push(a);a.isParented=true;if(this.isParented){a.initSelf()}},removeConstraint:function(b){var a=JPE.Array.indexOf(this.constraints,b);if(a===-1){return}this.constraints.splice(a,1);b.cleanup()},paint:function(){var g=this.particles,e=this.constraints,d=g.length,a=e.length,f,h,b;for(b=0;b<d;b++){f=g[b];if((!f.getFixed())||f.getAlwaysRepaint()){f.paint()}}for(b=0;b<a;b++){h=e[b];if((!h.getFixed())||h.getAlwaysRepaint()){h.paint()}}},getAll:function(){return this.particles.concat(this.constraints)},cleanup:function(){var e=this.particles,d=this.constraints,c=e.length,a=d.length,b;for(b=0;b<c;b++){e[b].cleanup()}for(b=0;b<a;b++){d[b].cleanup()}},integrate:function(a){var d=this.particles,c=d.length,b=0;for(;b<c;b++){d[b].update(a)}},satisfyConstraints:function(){var c=this.constraints,a=c.length,b=0;for(;b<a;b++){c[b].resolve()}},checkInternalCollisions:function(){var d=JPE.CollisionDetector,a=this.particles,l=this.constraints,f=a.length,o=l.length,b,n,m,h,g,e;for(h=0;h<f;h++){b=a[h];if(!b.getCollidable()){continue}for(g=h+1;g<f;g++){n=a[g];if(n.getCollidable()){d.test(b,n)}}for(e=0;e<o;e++){m=l[e];if(m.getCollidable()&&!m.isConnectedTo(b)){m.scp.updatePosition();d.test(b,m.scp)}}}},checkCollisionsVsCollection:function(y){var g=JPE.CollisionDetector,o=this.particles,x=y.particles,e=y.constraints,v=o.length,a=x.length,l=e.length,h,b,w,u,r,q;for(u=0;u<v;u++){h=o[u];if(!h.getCollidable()){continue}for(r=0;r<a;r++){b=x[r];if(b.getCollidable()){g.test(h,b)}}for(q=0;q<l;q++){w=e[q];if(w.getCollidable()&&!w.isConnectedTo(h)){w.scp.updatePosition();g.test(h,w.scp)}}}var d=this.constraints,f=d.length,m,t;for(r=0;r<f;r++){t=d[r];if(!t.getCollidable()){continue}for(m=0;m<a;m++){h=x[m];if(h.getCollidable()&&!t.isConnectedTo(h)){t.scp.updatePosition();g.test(h,t.scp)}}}}});JPE.declare("AbstractParticle",{superclass:JPE.AbstractItem,constructor:function(b,g,f,c,e,d){JPE.AbstractParticle.superclass.prototype.constructor.apply(this,null);this.interval=new JPE.Interval(0,0);var a=JPE.Vector;this.curr=new a(b,g);this.prev=new a(b,g);this.samp=new a();this.temp=new a();this.smashable=false;this.maxExitVelocity=0;this.smashSignal=new JPE.SmashSignal();this.forces=new a();this.collision=new JPE.Collision(new a(),new a());this._fixed=f;this._collidable=true;this.setMass(c);this._elasticity=e;this._friction=d;this._center=new a();this._multisample=0;this.setStyle()},getElasticity:function(){return this._elasticity},setElasticity:function(a){return this._elasticity=a},getMultisample:function(){return this._multisample},setMultisample:function(a){return this._multisample=a},getCollidable:function(){return this._collidable},setCollidable:function(a){this._collidable=a},getFixed:function(){return this._fixed},setFixed:function(a){this._fixed=a},getMass:function(){return this._mass},setMass:function(a){if(a<=0){throw new Error("mass may not be set <= 0")}this._mass=a;this._invMass=1/this._mass},getCenter:function(){this._center.setTo(this.getPx(),this.getPy());return this._center},getFriction:function(){return this._friction},setFriction:function(a){if(a<0||a>1){throw new Error("Legal friction must be >= 0 and <=1")}this._friction=a},getPosition:function(){return new JPE.Vector(this.curr.x,this.curr.y)},setPosition:function(a){this.curr.copy(a);this.prev.copy(a)},getPx:function(){return this.curr.x},setPx:function(a){this.curr.x=a;this.prev.x=a},getPy:function(){return this.curr.y},setPy:function(a){this.curr.y=a;this.prev.y=a},getVelocity:function(){return this.curr.minus(this.prev)},setVelocity:function(a){this.prev=this.curr.minus(a)},addForce:function(a){this.forces.plusEquals(a.mult(this.getInvMass()))},addMasslessForce:function(a){this.forces.plusEquals(a)},update:function(a){if(this.getFixed()){return}this.addForce(JPE.Engine.force);this.addMasslessForce(JPE.Engine.masslessForce);this.temp.copy(this.curr);var b=this.getVelocity().plus(this.forces.multEquals(a));this.curr.plusEquals(b.multEquals(JPE.Engine.damping));this.prev.copy(this.temp);this.forces.setTo(0,0)},getComponents:function(a){var b=this.getVelocity();var c=a.dot(b);this.collision.vn=a.mult(c);this.collision.vt=b.minus(this.collision.vn);return this.collision},resolveCollision:function(a,c){this.curr.plusEquals(a);this.setVelocity(c);if(this.smashable){var b=c.magnitude();if(b>this.maxExitVelocity){this.smashSignal.dispatch(JPE.SmashSignal.COLLISION)}}},getInvMass:function(){return(this.getFixed())?0:this._invMass}});JPE.declare("Group",{superclass:JPE.AbstractCollection,constructor:function(a){JPE.Group.superclass.prototype.constructor.call(this);this.composites=[];this.collisionList=[];this.collideInternal=a},initSelf:function(){JPE.Group.superclass.prototype.initSelf.apply(this,arguments);for(var b=0,a=this.composites.length;b<a;b++){this.composites[b].initSelf()}},addComposite:function(a){this.composites.push(a);a.isParented=true;if(this.isParented){a.initSelf()}},removeComposite:function(b){var a=JPE.Array.indexOf(this.composites,b);if(a===-1){return}this.composites.splice(a,1);b.isParented=false;b.cleanup()},paint:function(){JPE.Group.superclass.prototype.paint.apply(this,arguments);var d=this.composites,b=0,e,a=this.composites.length;for(;b<a;b++){e=d[b];e.paint()}},addCollidable:function(a){this.collisionList.push(a)},removeCollidable:function(a){var b=JPE.Array.indexOf(this.collisionList,a);if(b==-1){return}this.collisionList.splice(b,1)},addCollidableList:function(d){var c=0,b=d.length,a=this.collisionList;for(;c<b;c++){a.push(d[c])}},getAll:function(){return this.particles.concat(this.constraints).concat(this.composites)},cleanup:function(){JPE.Group.superclass.prototype.cleanup.apply(this,arguments);var c=this.composites,a=c.length,b=0;for(;b<a;b++){c[b].cleanup()}},integrate:function(b){JPE.Group.superclass.prototype.integrate.apply(this,arguments);var d=this.composites,a=d.length,c=0;for(;c<a;c++){d[c].integrate(b)}},satisfyConstraints:function(){JPE.Group.superclass.prototype.satisfyConstraints.apply(this,null);var c=this.composites,a=c.length,b=0;for(;b<a;b++){c[b].satisfyConstraints()}},checkCollisions:function(){if(this.collideInternal){this.checkCollisionGroupInternal()}var a=this.collisionList,c=a.length,b=0;for(;b<c;b++){this.checkCollisionVsGroup(a[b])}},checkCollisionGroupInternal:function(){this.checkInternalCollisions();var f=this.composites,g,e,a=f.length,d=0,b;for(;d<a;d++){g=f[d];g.checkCollisionsVsCollection(this);for(b=d+1;b<a;b++){e=f[b];g.checkCollisionsVsCollection(e)}}},checkCollisionVsGroup:function(h){this.checkCollisionsVsCollection(h);var f=this.composites,l,k,a=f.length,b=h.composites.length,e=0,d;for(;e<a;e++){l=f[e];l.checkCollisionsVsCollection(h);for(d=0;d<b;d++){k=h.composites[d];l.checkCollisionsVsCollection(k)}}for(d=0;d<b;d++){k=h.composites[d];this.checkCollisionsVsCollection(k)}}});JPE.declare("Composite",{superclass:JPE.AbstractCollection,constructor:function(){JPE.Composite.superclass.prototype.constructor.apply(this);this.delta=new JPE.Vector()},rotateByRadian:function(f,c){var g,e=this.particles,b=e.length;for(var d=0;d<b;d++){g=e[d];var a=g.getCenter().distance(c);var h=this.getRelativeAngle(c,g.getCenter())+f;g.setPx(Math.cos(h)*a+c.x);g.setPy(Math.sin(h)*a+c.y)}},rotateByAngle:function(c,a){var b=c*JPE.MathUtil.PI_OVER_ONE_EIGHTY;this.rotateByRadian(b,a)},getFixed:function(){for(var b=0,a=this.particles.length;b<a;b++){if(!particles[b].getFixed()){return false}}return true},setFixed:function(a){for(var d=0,c=this.particles.length;d<c;d++){this.particles[d].setFixed(a)}},getRelativeAngle:function(a,b){this.delta.setTo(b.x-a.x,b.y-a.y);return Math.atan2(this.delta.y,this.delta.x)}});JPE.declare("CircleParticle",{superclass:JPE.AbstractParticle,constructor:function(b,g,a,d,c,f,e){c=c||1;f=f||0.3;e=e||0;this._radius=a;JPE.CircleParticle.superclass.prototype.constructor.call(this,b,g,d,c,f,e)},getRadius:function(){return this._radius},setRadius:function(a){this._radius=a},getProjection:function(a){var b=this.samp.dot(a);this.interval.min=b-this._radius;this.interval.max=b+this._radius;return this.interval},getIntervalX:function(){this.interval.min=this.curr.x-this._radius;this.interval.max=this.curr.x+this._radius;return this.interval},getIntervalY:function(){this.interval.min=this.curr.y-this._radius;this.interval.max=this.curr.y+this._radius;return this.interval}});JPE.declare("RectangleParticle",{superclass:JPE.AbstractParticle,constructor:function(f,e,a,g,h,c,d,i,b){h=h||0;d=d||1;i=i||0.3;b=b||0;this._extents=[a/2,g/2];this._axes=[new JPE.Vector(0,0),new JPE.Vector(0,0)];this.setRadian(h);JPE.RectangleParticle.superclass.prototype.constructor.call(this,f,e,c,d,i,b)},getRadian:function(){return this._radian},setRadian:function(a){this._radian=a;this.setAxes(a)},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},setAngle:function(b){this.setRadian(b*JPE.MathUtil.PI_OVER_ONE_EIGHTY)},setWidth:function(a){this._extents[0]=a/2},getWidth:function(){return this._extents[0]*2},setHeight:function(a){this._extents[1]=a/2},getHeight:function(){return this._extents[1]*2},getExtents:function(){return this._extents},getProjection:function(b){var e=this.getAxes(),d=this.getExtents(),a=d[0]*Math.abs(b.dot(e[0]))+d[1]*Math.abs(b.dot(e[1]));var f=this.samp.dot(b);this.interval.min=f-a;this.interval.max=f+a;return this.interval},getAxes:function(){return this._axes},setAxes:function(a){var b=Math.sin(a),e=Math.cos(a),d=this.getAxes();d[0].x=e;d[0].y=b;d[1].x=-b;d[1].y=e}});JPE.declare("RimParticle",{constructor:function(b,a){this.sp=0;this.av=0;this.wr=b;this.maxTorque=a;this.curr=new JPE.Vector(b,0);this.prev=new JPE.Vector(0,0)},getSpeed:function(){return this.sp},setSpeed:function(a){this.sp=a},getAngularVelocity:function(){return this.av},setAngularVelocity:function(a){this.av=a},update:function(b){this.sp=Math.max(-this.maxTorque,Math.min(this.maxTorque,this.sp+this.av));var j=-this.curr.y;var i=this.curr.x;var d=Math.sqrt(j*j+i*i);j/=d;i/=d;this.curr.x+=this.sp*j;this.curr.y+=this.sp*i;var c=this.prev.x;var a=this.prev.y;var h=this.prev.x=this.curr.x;var f=this.prev.y=this.curr.y;this.curr.x+=JPE.Engine.damping*(h-c);this.curr.y+=JPE.Engine.damping*(f-a);var e=Math.sqrt(this.curr.x*this.curr.x+this.curr.y*this.curr.y);var g=(e-this.wr)/e;this.curr.x-=this.curr.x*g;this.curr.y-=this.curr.y*g}});JPE.declare("WheelParticle",{superclass:JPE.CircleParticle,constructor:function(b,h,a,d,c,f,e,g){g=g||1;c=c||1;f=f||0.3;e=e||0;this.lineThickness=1;JPE.WheelParticle.superclass.prototype.constructor.apply(this,arguments);this.tan=new JPE.Vector(0,0);this.normSlip=new JPE.Vector(0,0);this.rp=new JPE.RimParticle(a,2);this.orientation=new JPE.Vector();this.setTraction(g)},getSpeed:function(){return this.rp.getSpeed()},setSpeed:function(a){this.rp.setSpeed(a)},getAngularVelocity:function(){return this.rp.getAngularVelocity()},setAngularVelocity:function(a){this.rp.setAngularVelocity(a)},getTraction:function(){return 1-this._traction},setTraction:function(a){this._traction=1-a},update:function(a){JPE.WheelParticle.superclass.prototype.update.call(this,a);this.rp.update(a)},getRadian:function(){this.orientation.setTo(this.rp.curr.x,this.rp.curr.y);return Math.atan2(this.orientation.y,this.orientation.x)+Math.PI},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},resolveCollision:function(a,b,g,f,e,c){JPE.WheelParticle.superclass.prototype.resolveCollision.apply(this,arguments);this.resolve(g.mult(JPE.MathUtil.sign(f*e)))},resolve:function(g){var d=this.rp,c=this.tan;c.setTo(-d.curr.y,d.curr.x);c=c.normalize();var f=c.mult(d.getSpeed());var b=this.getVelocity().plusEquals(f);var e=b.cross(g);c.multEquals(e);d.prev.copy(d.curr.minus(c));var a=(1-this._traction)*d.getSpeed();this.normSlip.setTo(a*g.y,a*g.x);this.curr.plusEquals(this.normSlip);d.setSpeed(d.getSpeed()*this._traction)}});JPE.declare("AbstractConstraint",{superclass:JPE.AbstractItem,constructor:function(a){this.stiffness=a;this.setStyle();this._pool={};this.beforeRenderSignal=new JPE.Signal();this.afterRenderSignal=new JPE.Signal()},resolve:function(){}});JPE.declare("SpringConstraint",{superclass:JPE.AbstractConstraint,constructor:function(f,e,b,a,c,g,d){b=b||0.5;c=c||1;g=g||1;JPE.SpringConstraint.superclass.prototype.constructor.call(this,b);this.p1=f;this.p2=e;this.checkParticlesLocation();this._restLength=this.getCurrLength();this.inited=false;this.setCollidable(a,c,g,d)},getRadian:function(){var a=this.getDelta();return Math.atan2(a.y,a.x)},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},getCenter:function(){return(this.p1.curr.plus(this.p2.curr)).divEquals(2)},setRectScale:function(a){if(this.scp==null){return}this.scp.setRectScale(a)},getRectScale:function(){return this.scp.getRectScale()},getCurrLength:function(){return this.p1.curr.distance(this.p2.curr)},getRectHeight:function(){return this.scp.getRectHeight()},setRectHeight:function(a){if(this.scp==null){return}this.scp.setRectHeight(a)},getRestLength:function(){return this._restLength},setRestLength:function(a){if(a<=0){throw new Error("restLength must be greater than 0")}this._restLength=a},getFixedEndLimit:function(){return this.scp.getFixedEndLimit()},setFixedEndLimit:function(a){if(this.scp==null){return}this.scp.setFixedEndLimit(a)},getCollidable:function(){return this._collidable},setCollidable:function(a,c,e,d){this._collidable=a;this.scp=null;if(this._collidable){if(this.scp){this.scp.cleanup()}this.scp=new JPE.SpringConstraintParticle(this.p1,this.p2,this,c,e,d);if(this.inited){this.scp.initSelf()}}},isConnectedTo:function(a){return(a==this.p1||a==this.p2)},getFixed:function(){return this.p1.getFixed()&&this.p2.getFixed()},initSelf:function(){if(this.getCollidable()){this.scp.initSelf()}this.inited=true},cleanup:function(){if(this.getCollidable()){this.scp.cleanup()}this.inited=false},getDelta:function(){return this.p1.curr.minus(this.p2.curr)},resolve:function(){var e=this.p1,d=this.p2;if(e.getFixed()&&d.getFixed()){return}var a=this.getCurrLength();var c=(a-this.getRestLength())/(a*(e.getInvMass()+d.getInvMass()));var b=this.getDelta().mult(c*this.stiffness);this.p1.curr.minusEquals(b.mult(e.getInvMass()));this.p2.curr.plusEquals(b.mult(d.getInvMass()))},checkParticlesLocation:function(){if(this.p1.curr.x==this.p2.curr.x&&this.p1.curr.y==this.p2.curr.y){this.p2.curr.x+=0.0001}}});JPE.declare("SpringConstraintParticle",{superclass:JPE.RectangleParticle,constructor:function(e,d,c,a,f,b){this.p1=e;this.p2=d;this.lambda=new JPE.Vector(0,0);this.avgVelocity=new JPE.Vector(0,0);this.parent=c;JPE.SpringConstraintParticle.superclass.prototype.constructor.call(this,0,0,0,0,0,false);this._rectScale=f;this._rectHeight=a;this.scaleToLength=b;this._fixedEndLimit=0;this.rca=new JPE.Vector();this.rcb=new JPE.Vector()},setRectScale:function(a){this._rectScale=a},getRectScale:function(){return this._rectScale},setRectHeight:function(a){this._rectHeight=a},getRectHeight:function(){return this._rectHeight},setFixedEndLimit:function(a){this._fixedEndLimit=a},getFixedEndLimit:function(){return this._fixedEndLimit},getMass:function(){return(this.p1.getMass()+this.p2.getMass())/2},getElasticity:function(){return(this.p1.getElasticity()+this.p2.getElasticity())/2},getFriction:function(){return(this.p1.getFriction()+this.p2.getFriction())/2},getVelocity:function(){var a=this.p1.getVelocity();var b=this.p2.getVelocity();this.avgVelocity.setTo(((a.x+b.x)/2),((a.y+b.y)/2));return this.avgVelocity},getInvMass:function(){if(this.p1.getFixed()&&this.p2.getFixed()){return 0}return 1/((this.p1.getMass()+this.p2.getMass())/2)},updatePosition:function(){var a=this.parent.getCenter();this.curr.setTo(a.x,a.y);this.setWidth((this.scaleToLength)?this.parent.getCurrLength()*this._rectScale:this.parent.getRestLength()*this._rectScale);this.setHeight(this.getRectHeight());this.setRadian(this.parent.getRadian())},resolveCollision:function(u,l,e,k,c,b){var r=this.getContactPointParam(b);var g=(1-r);var f=r;var q=this.p1;var m=this.p2;var j=this.getFixedEndLimit();var i=this.lambda;if(q.getFixed()){if(f<=j){return}i.setTo(u.x/f,u.y/f);m.curr.plusEquals(i);m.setVelocity(l)}else{if(m.getFixed()){if(g<=j){return}i.setTo(u.x/g,u.y/g);q.curr.plusEquals(i);q.setVelocity(l)}else{var h=(g*g+f*f);if(h==0){return}i.setTo(u.x/h,u.y/h);q.curr.plusEquals(i.mult(g));m.curr.plusEquals(i.mult(f));if(r==0.5){q.setVelocity(l);m.setVelocity(l)}else{var a=(r<0.5)?q:m;a.setVelocity(l)}}}},closestParamPoint:function(d){var b=this.p2.curr.minus(this.p1.curr);var a=(b.dot(d.minus(this.p1.curr)))/(b.dot(b));return JPE.MathUtil.clamp(a,0,1)},getContactPointParam:function(f){var c;if(f instanceof JPE.CircleParticle){c=this.closestParamPoint(f.curr)}else{if(f instanceof JPE.RectangleParticle){var e;var a=new Array(4);var h=Number.POSITIVE_INFINITY;for(var b=0;b<4;b++){this.setCorners(f,b);var g=this.closestPtSegmentSegment();if(g<h){h=g;e=b;a[b]=s}}c=a[e]}}return c},setCorners:function(a,h){var e=a.curr.x;var c=a.curr.y;var l=a.getAxes();var p=a.getExtents();var g=l[0].x*p[0];var f=l[0].y*p[0];var k=l[1].x*p[1];var j=l[1].y*p[1];var q=g-k;var o=f-j;var n=g+k;var m=f+j;var d=this.rca;var b=this.rcb;if(h==0){d.x=e-n;d.y=c-m;b.x=e+q;b.y=c+o}else{if(h==1){d.x=e+q;d.y=c+o;b.x=e+n;b.y=c+m}else{if(h==2){d.x=e+n;d.y=c+m;b.x=e-q;b.y=c-o}else{if(h==3){d.x=e-q;d.y=c-o;b.x=e-n;b.y=c-m}}}}},closestPtSegmentSegment:function(){var j=this.p1.curr,x=this.p2.curr,i=this.rca,w=this.rcb,h=x.minus(j),d=w.minus(i),g=j.minus(i),y,v=h.dot(h),o=d.dot(d),n=d.dot(g),q=h.dot(g),u=h.dot(d),m=v*o-u*u;if(m!=0){s=JPE.MathUtil.clamp((u*n-q*o)/m,0,1)}else{s=0.5}y=(u*s+n)/o;if(y<0){y=0;s=JPE.MathUtil.clamp(-q/v,0,1)}else{if(y>0){y=1;s=JPE.MathUtil.clamp((u-q)/v,0,1)}}var l=j.plus(h.mult(s));var k=i.plus(d.mult(y));var p=l.minus(k);return p.dot(p)}});JPE.declare("Renderer",{constructor:function(){this._items={};this._delegates={}},registerDelegate:function(b,c,a){this._items[b]=c;this._delegates[b]=a},getParticleClass:function(a){return this._items[a]},getDelegateClass:function(a){return this._delegates[a]},findDelegateByParticle:function(b){var a=b.constructor,d=this._items,c=this._delegates;while(a.superclass){for(var e in d){if(d[e]===a){return c[e]}}a=a.superclass}return null},getRenderDelegate:function(b){var a=b.get("renderDelegate");if(a==undefined){a=this.findDelegateByParticle(b);b.set("renderDelegate",a)}return a},initSelf:function(b){var a=this.getRenderDelegate(b);a&&a.initSelf(b)},cleanup:function(b){var a=this.getRenderDelegate(b);a&&a.cleanup(b)},render:function(b){var a=this.getRenderDelegate(b);a&&a.render(b)},setVisible:function(b){var a=this.getRenderDelegate(b);a&&a.setVisible(b)}});JPE.declare("EaselRenderer",{superclass:JPE.Renderer,constructor:function(a){JPE.EaselRenderer.superclass.prototype.constructor.apply(this,arguments);this.stage=a;this.registerDelegate("RectangleParticle",JPE.RectangleParticle,new JPE.EaselRenderer.RectangleParticleDelegate(this));this.registerDelegate("CircleParticle",JPE.CircleParticle,new JPE.EaselRenderer.CircleParticleDelegate(this));this.registerDelegate("WheelParticle",JPE.WheelParticle,new JPE.EaselRenderer.WheelParticleDelegate(this));this.registerDelegate("SpringConstraintParticle",JPE.SpringConstraintParticle,new JPE.EaselRenderer.SpringConstraintParticleDelegate(this));this.registerDelegate("SpringConstraint",JPE.SpringConstraint,new JPE.EaselRenderer.SpringConstraintDelegate(this))}});JPE.declare("EaselRenderer.AbstractDelegate",{constructor:function(a){this.renderer=a;this.stage=a.stage},initSelf:function(c){var b=new Container(),a=new Shape();b.addChild(a);if(!c.getVisible()){b.visible=false}this.stage.addChild(b);c.set("sprite",b);c.set("shape",a);this.drawShape(c)},cleanup:function(b){var a=b.get("sprite");if(a){this.stage.removeChild(a)}},drawShape:function(a){},setVisible:function(b){var a=b.get("sprite");if(a){a.visible=b.getVisible()}},render:function(a){}});JPE.declare("EaselRenderer.RectangleParticleDelegate",{superclass:JPE.EaselRenderer.AbstractDelegate,drawShape:function(e){var b=e.get("shape"),d=b.graphics,a=e.getExtents()[0]*2,c=e.getExtents()[1]*2;b.x=-a/2;b.y=-c/2;d.clear();if(e.lineThickness){d.setStrokeStyle(e.lineThickness);d.beginStroke(Graphics.getRGB(e.lineColor,e.lineAlpha))}d.beginFill(Graphics.getRGB(e.fillColor,e.fillAlpha));d.drawRect(0,0,a,c);d.endFill()},render:function(f){var c=f.get("sprite"),a=f.curr.x,g=f.curr.y,b=f.getExtents()[0]*2,d=f.getExtents()[1]*2,e=f.getAngle();if(c){this.drawShape(f);c.rotation=e;c.x=a;c.y=g}}});JPE.declare("EaselRenderer.CircleParticleDelegate",{superclass:JPE.EaselRenderer.AbstractDelegate,drawShape:function(d){var c=d.getRadius(),a=d.get("shape"),b=a.graphics;b.clear();if(d.lineThickness){b.setStrokeStyle(d.lineThickness);b.beginStroke(Graphics.getRGB(d.lineColor,d.lineAlpha))}b.beginFill(Graphics.getRGB(d.fillColor,d.fillAlpha));b.drawCircle(0,0,c);b.endFill()},render:function(c){var a=c.curr.x,d=c.curr.y,b=c.get("sprite");if(b){this.drawShape(c);b.x=a;b.y=d}}});JPE.declare("EaselRenderer.WheelParticleDelegate",{superclass:JPE.EaselRenderer.AbstractDelegate,drawShape:function(d){var c=d.getRadius(),a=d.get("shape"),b=a.graphics;b.clear();if(d.lineThickness){b.setStrokeStyle(d.lineThickness);b.beginStroke(Graphics.getRGB(d.lineColor,d.lineAlpha))}b.beginFill(Graphics.getRGB(d.fillColor,d.fillAlpha));b.drawCircle(0,0,c);b.setStrokeStyle(1);b.beginStroke(Graphics.getRGB(16777215-d.lineColor));b.moveTo(-c,0);b.lineTo(c,0);b.moveTo(0,-c);b.lineTo(0,c);b.endFill()},render:function(d){var a=d.curr.x,e=d.curr.y,c=d.getAngle(),b=d.get("sprite");if(b){this.drawShape(d);b.rotation=c;b.x=a;b.y=e}}});JPE.declare("EaselRenderer.SpringConstraintParticleDelegate",{superclass:JPE.EaselRenderer.AbstractDelegate,initSelf:function(d){var b=new Container(),a=new Shape(),c=d.parent,e=c.get("sprite");if(!e){e=new Container();c.set("sprite",e)}d.set("sprite",b);d.set("shape",a);if(!d.getVisible()){sprite.visible=false}b.addChild(a);e.addChild(b);this.drawShape(d);this.stage.addChild(e)},cleanup:function(b){var a=b.parent;this.stage.removeChild(a.get("sprite"))},drawShape:function(i){var b=i.get("shape"),f=b.graphics,e=i.parent,j=e.getCenter(),a=e.getCurrLength()*i.getRectScale(),d=i.getRectHeight();f.clear();if(e.lineThickness){f.setStrokeStyle(e.lineThickness);f.beginStroke(Graphics.getRGB(e.lineColor,e.lineAlpha))}f.beginFill(Graphics.getRGB(e.fillColor,e.fillAlpha));f.drawRect(-a/2,-d/2,a,d);f.endFill()},render:function(e){var d=e.parent,f=d.getCenter(),b=e.get("sprite"),a=e.get("shape");b.x=f.x;b.y=f.y;if(e.scaleToLength){b.width=d.getCurrLength()*e.getRectScale()}b.rotation=d.getAngle()}});JPE.declare("EaselRenderer.SpringConstraintDelegate",{superclass:JPE.EaselRenderer.AbstractDelegate,initSelf:function(a){},cleanup:function(b){var a=b.get("sprite");if(a){this.stage.removeChild(a)}},initShape:function(c){var b=new Container(),a=new Shape();c.set("sprite",b);c.set("shape",a);b.addChild(a);this.stage.addChild(b)},drawShape:function(c){var a=c.get("shape"),b=a.graphics,e=c.p1,d=c.p2;b.clear();if(c.lineThickness){b.setStrokeStyle(c.lineThickness);b.beginStroke(Graphics.getRGB(c.lineColor,c.lineAlpha))}b.moveTo(e.getPx(),e.getPy());b.lineTo(d.getPx(),d.getPy());b.endFill()},render:function(a){if(a.getCollidable()){a.scp.paint()}else{if(!a.get("shape")){this.initShape(a)}this.drawShape(a)}}});